name: GitHub Actions Demo
run-name: Build demo app ðŸš€
on: [push]
jobs:
    build:
        runs-on: ubuntu-latest
        environment: dev
        permissions:
          contents: read
          id-token: write
        
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              id: gcloud-auth
              uses: google-github-actions/auth@v2
              with:
                token_format: 'access_token'
                workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
                service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

            - name: Setup jdk 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: 'gradle'
            
            - name: Build with Gradle
              run: |
                    ./gradlew build \
                        -Dquarkus.native.enabled=true \
                        -Dquarkus.native.container-build=true \
                        -Dquarkus.package.jar.enabled=false
              working-directory: ./afl-tracker

            - name: Login to Artifact Registry
              uses: docker/login-action@v3
              with:
                  registry: ${{ vars.GCP_REGION }}-docker.pkg.dev
                  username: oauth2accesstoken
                  password: ${{ steps.gcloud-auth.outputs.access_token }}

            - name: Build and Push Docker Image
              env:
                  IMAGE_NAME: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/afl-tracker-repo/afl-tracker-backend
              run: |
                    ls -lh build/
                    docker build \
                        -f src/main/docker/Dockerfile.native-micro \
                        -t $IMAGE_NAME:$GITHUB_SHA \
                        -t $IMAGE_NAME:latest \
                        .
                    docker push $IMAGE_NAME:$GITHUB_SHA
                    docker push $IMAGE_NAME:latest
                    echo "IMAGE_URI=$IMAGE_NAME:$GITHUB_SHA" >> $GITHUB_ENV
              working-directory: ./afl-tracker

            - name: Pulumi Deploy
              uses: pulumi/actions@v6
              with:
                  command: up --yes
                  stack-name: dev
                  work-dir: ./pulumi-infra
              env:
                  PULUMI_ACCESS_TOKEN: ${{ secrets.PULUMI_ACCESS_TOKEN }}
                  GCP_ACCESS_TOKEN: ${{ steps.gcloud-auth.outputs.access_token }}
                  PULUMI_CONFIG_PASSTHROUGH: gcp:project=${{ vars.GCP_PROJECT_ID }},gcp:region=${{ vars.GCP_REGION }},app-image=${{ env.IMAGE_URI }}
