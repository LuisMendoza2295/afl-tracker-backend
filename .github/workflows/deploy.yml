name: GitHub Actions Demo
run-name: Build demo app ðŸš€
on: [push]
jobs:
    build:
        runs-on: ubuntu-latest
        environment: dev
        permissions:
          contents: read
          id-token: write
        
        steps:
            - name: Check out repository code
              uses: actions/checkout@v4

            - name: Authenticate to Google Cloud
              uses: google-github-actions/auth@v2
              with:
                  workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
                  service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

            - name: Setup jdk 21
              uses: actions/setup-java@v4
              with:
                  java-version: '21'
                  distribution: 'temurin'
                  cache: 'gradle'
            
            - name: Build with Gradle
              run: |
                    ./gradlew build \
                        -Dquarkus.native.enabled=true \
                        -Dquarkus.native.container-build=true \
                        -Dquarkus.package.jar.enabled=false
              working-directory: ./afl-tracker

            - name: Login to Artifact Registry
              run: gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev

            - name: Build and Push Docker Image
              env:
                  IMAGE_NAME: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/demo-repo/gh-actions-demo
              run: |
                    ls -lh build/
                    docker build \
                        -f src/main/docker/Dockerfile.native-micro \
                        -t $IMAGE_NAME:$GITHUB_SHA \
                        -t $IMAGE_NAME:latest \
                        .
                    docker push $IMAGE_NAME:$GITHUB_SHA
                    docker push $IMAGE_NAME:latest
              working-directory: ./afl-tracker