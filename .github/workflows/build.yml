name: build-test-and-push-image
run-name: Build AFL tracker backend by @${{ github.actor }} ðŸš€
on: [push]
jobs:
    build-and-test:
      runs-on: ubuntu-latest
      environment: dev
      permissions:
        contents: read
        id-token: write

      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Setup jdk 21 for build
          uses: actions/setup-java@v4
          with:
              java-version: '21'
              distribution: 'temurin'
              cache: 'gradle'
        
        - name: Build with Gradle
          run: |
                ./gradlew clean build \
                    -Dquarkus.package.jar.enabled=true \
                    -Dquarkus.package.jar.type=fast-jar
          working-directory: ./afl-tracker
        
        - name: Upload Build Artifact
          uses: actions/upload-artifact@v4
          with:
              name: quarkus-app
              path: ./afl-tracker/build/quarkus-app/

    build-and-push-image:
      runs-on: ubuntu-latest
      needs: build-and-test
      environment: dev
      permissions:
        contents: read
        id-token: write
      outputs:
        image_uri: ${{ steps.push_step.outputs.IMAGE_URI }}
      
      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Download JVM artifact
          uses: actions/download-artifact@v4
          with:
              name: quarkus-app
              path: ./afl-tracker/build/quarkus-app

        - name: Authenticate to Google Cloud
          id: gcloud-auth
          uses: google-github-actions/auth@v2
          with:
            token_format: 'access_token'
            workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
            service_account: ${{ vars.GCP_APP_DEPLOYER_SERVICE_ACCOUNT }}

        - name: Login to Artifact Registry
          uses: docker/login-action@v3
          with:
              registry: ${{ vars.GCP_REGION }}-docker.pkg.dev
              username: oauth2accesstoken
              password: ${{ steps.gcloud-auth.outputs.access_token }}

        - name: Build and Push Docker Image
          id: push_step
          env:
              IMAGE_NAME: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/afl-tracker-repo/afl-tracker-backend
          run: |
                ls -lh build/
                docker build \
                    -f src/main/docker/Dockerfile.jvm \
                    -t $IMAGE_NAME:$GITHUB_SHA \
                    -t $IMAGE_NAME:latest \
                    .
                docker push $IMAGE_NAME:$GITHUB_SHA
                docker push $IMAGE_NAME:latest
                echo "IMAGE_URI=$IMAGE_NAME:$GITHUB_SHA" >> "$GITHUB_OUTPUT"
          working-directory: ./afl-tracker

    pre-deploy-check:
      needs: build-and-push-image
      permissions:
        contents: read
        id-token: write
      uses: ./.github/workflows/pre-deploy-check.yml
      with:
        image_uri: ${{ needs.build-and-push-image.outputs.image_uri }}
      secrets: inherit