name: build-test-and-push-image
run-name: Build AFL tracker backend by @${{ github.actor }} ðŸš€
on: [push]
jobs:
    build-and-test:
      runs-on: ubuntu-latest
      environment: dev
      permissions:
        contents: read
        id-token: write

      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Setup jdk 21 for build
          uses: actions/setup-java@v4
          with:
              java-version: '21'
              distribution: 'temurin'
              cache: 'gradle'
        
        - name: Build with Gradle
          run: |
                ./gradlew build \
                    -Dquarkus.native.enabled=true \
                    -Dquarkus.native.container-build=true \
                    -Dquarkus.package.jar.enabled=false
          working-directory: ./afl-tracker
        
        - name: Native runner artifact
          uses: actions/upload-artifact@v4
          with:
              name: native-runner
              path: ./afl-tracker/build/afl-tracker-1.0.0-SNAPSHOT-runner

    build-and-push-image:
      runs-on: ubuntu-latest
      needs: build-and-test
      environment: dev
      permissions:
        contents: read
        id-token: write
      outputs:
        image_uri: ${{ steps.push_step.outputs.IMAGE_URI }}
      
      steps:
        - name: Check out repository code
          uses: actions/checkout@v4

        - name: Download native runner artifact
          uses: actions/download-artifact@v4
          with:
              name: native-runner
              path: ./afl-tracker/build

        - name: Fix Permissions
          run: chmod +x build/*-runner
          working-directory: ./afl-tracker

        - name: Authenticate to Google Cloud
          id: gcloud-auth
          uses: google-github-actions/auth@v2
          with:
            token_format: 'access_token'
            workload_identity_provider: ${{ vars.WIF_PROVIDER }}
            service_account: ${{ vars.APP_DEPLOYER_SERVICE_ACCOUNT }}

        - name: Login to Artifact Registry
          uses: docker/login-action@v3
          with:
              registry: ${{ vars.GCP_REGION }}-docker.pkg.dev
              username: oauth2accesstoken
              password: ${{ steps.gcloud-auth.outputs.access_token }}

        - name: Build and Push Docker Image
          id: push_step
          env:
              IMAGE_NAME: ${{ vars.GCP_REGION }}-docker.pkg.dev/${{ vars.GCP_PROJECT_ID }}/afl-tracker-repo/afl-tracker-backend
          run: |
                ls -lh build/
                docker build \
                    -f src/main/docker/Dockerfile.native-micro \
                    -t $IMAGE_NAME:$GITHUB_SHA \
                    -t $IMAGE_NAME:latest \
                    .
                docker push $IMAGE_NAME:$GITHUB_SHA
                docker push $IMAGE_NAME:latest
                echo "IMAGE_URI=$IMAGE_NAME:$GITHUB_SHA" >> "$GITHUB_OUTPUT"
          working-directory: ./afl-tracker